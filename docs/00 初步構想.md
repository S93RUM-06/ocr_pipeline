以下是一份 **正式版《OCR Pipeline 設計文件（Markdown）》**，定位為
👉 **可交付、可審查、可實作的工程設計文件**
👉 適合放在 repo（如 `docs/ocr_pipeline_design.md`）或做為內部規格書

內容已刻意 **不綁定任何單一 OCR 引擎**，方便後續接 PaddleOCR / Tesseract / 其他方案。

---

# OCR Pipeline 設計文件

## 1. 文件目的（Purpose）

本文件定義一套 **模組化、可配置、可擴充的 OCR 辨識生產流程（OCR Pipeline）**，
用於在實際 OCR 引擎執行前，完成：

- 檔案格式統一
- 影像前處理與校正
- 文件版型（ROI）切割
- OCR 引擎抽象化
- 結果後處理與輸出管理

本設計目標為 **工程級 OCR 系統**，而非單一模型或腳本。

---

## 2. 設計原則（Design Principles）

1. **Pipeline 與 OCR Engine 解耦**
2. **Config-driven（設定驅動，而非寫死）**
3. **模組可插拔（Pluggable Components）**
4. **支援同步與非同步處理**
5. **所有中間結果可追蹤（Artifacts）**
6. **可因應多文件版型（Template-based）**

---

## 3. 整體架構（System Architecture）

```

┌──────────────────────────────┐
│        Client / API          │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  OCR Pipeline Orchestrator   │
│    (流程控制 / 任務狀態)      │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│        Input Adapter         │
│    (格式轉換 / 影像標準化)    │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│   Preprocess Pipeline        │
│   (校正 / 去噪 / ROI 切割)    │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│   OCR Engine Adapter         │
│ (PaddleOCR / Tesseract ...)  │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│    Post-processing Layer     │
│    (校驗 / 正則 / 結構化)     │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│      Output & Storage        │
└──────────────────────────────┘

````

---

## 4. Pipeline 分層設計

### 4.1 Input Adapter（輸入轉換層）

#### 職責
- 接收不同來源與格式的輸入檔案
- 將所有輸入 **統一轉換為標準影像格式（PNG / JPEG）**
- 支援多頁文件（PDF / TIFF）

#### 支援格式
- PDF
- DOC / DOCX / ODT
- TIFF
- PNG / JPEG

#### 標準輸出結構
```json
{
  "source_id": "DOC_001",
  "pages": [
    {
      "page_index": 0,
      "image_path": "workspace/DOC_001/page_0.png"
    }
  ]
}
````

---

### 4.2 Preprocess Pipeline（影像前處理層）

#### 目標

在 OCR 前最大化影像品質與一致性，降低辨識誤差。

#### Pipeline 組成（順序可配置）

```
LoadImage
 → ResizeNormalize
 → GeometryCorrection
 → DenoiseEnhancement
 → Binarization
 → ROIExtraction
 → ArtifactSave
```

#### Step 通用介面（概念）

```python
class PreprocessStep:
    def run(self, context) -> context:
        pass
```

#### Context 結構（流程狀態）

```json
{
  "image": "<ndarray>",
  "image_size": [X0, Y0],
  "template": "invoice_v1",
  "regions": [],
  "artifacts": {}
}
```

---

### 4.3 Template / ROI 定義（版型系統）

#### 設計目的

* 支援多文件版型
* 不修改程式即可新增或調整辨識區塊

#### Template 定義（JSON 範例）

```json
{
  "template_id": "invoice_v1",
  "image_size": [2480, 3508],
  "preprocess": {
    "deskew": true,
    "denoise": "nlm",
    "binarize": "adaptive"
  },
  "regions": [
    {
      "name": "invoice_no",
      "rect": [300, 200, 900, 350],
      "ocr_lang": "eng"
    },
    {
      "name": "total_amount",
      "rect": [1600, 2800, 2300, 3000],
      "ocr_lang": "eng"
    }
  ]
}
```

---

### 4.4 OCR Engine Adapter（OCR 抽象層）

#### 設計目標

* OCR 引擎可替換
* Pipeline 不依賴特定實作

#### 統一介面

```python
class OCREngine:
    def recognize(self, image, config) -> OCRResult:
        pass
```

#### OCRResult 標準格式

```json
{
  "text": "12345",
  "confidence": 0.97,
  "engine": "paddleocr",
  "bbox": [x1, y1, x2, y2]
}
```

---

### 4.5 Post-processing（後處理層）

#### 職責

* 清洗 OCR 結果
* 驗證格式
* 結構化輸出

#### 常見處理

* Regex 驗證
* 數值正規化
* 字典校正
* 置信度過濾

---

### 4.6 Output & Artifact Management

#### 目錄結構建議

```
output/
  DOC_001/
    input/
    preprocessed/
    roi/
    ocr/
    result.json
```

#### Artifact 原則

* 所有中間結果可選擇保存
* 便於除錯與模型優化

---

## 5. API 與任務模型

### 5.1 同步 API（小量）

```http
POST /ocr/recognize
```

```json
{
  "file": "...",
  "template_id": "invoice_v1"
}
```

---

### 5.2 非同步 Job API（批次）

```http
POST /ocr/jobs
GET  /ocr/jobs/{job_id}
```

#### Job 狀態模型

```json
{
  "job_id": "JOB_001",
  "status": "PREPROCESSING",
  "current_step": "ROIExtraction"
}
```

---

## 6. 擴充性與未來規劃

* 新 OCR Engine → 新 Adapter
* 新文件格式 → 新 Input Adapter
* 新版型 → 新 Template
* 新前處理方法 → 新 PreprocessStep

---

## 7. 非功能性需求（Non-functional）

| 項目   | 說明             |
| ---- | -------------- |
| 可測試性 | 每個 Step 可單元測試  |
| 可觀測性 | Pipeline 狀態可追蹤 |
| 效能   | 支援批次與併行處理      |
| 可維護性 | 模組低耦合          |

---

## 8. 結論

本 OCR Pipeline 設計提供：

* 穩定、可擴充的前處理流程
* 與 OCR 引擎解耦的架構
* 支援多版型、多文件類型的生產需求

可作為企業級 OCR 系統或長期演進專案的基礎架構。

---
