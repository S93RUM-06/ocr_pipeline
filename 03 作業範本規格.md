# OCR Template 規格文件（統一版本）

## 1. 文件目的

定義 OCR 辨識所使用的 **文件版型（Template）格式**，支援兩種定位模式：
- **絕對座標模式**：固定位置的 ROI 區域（適用於格式統一的文件）
- **相對座標模式**：基於錨點的相對定位（適用於格式變化的文件）

---

## 2. 統一範本結構

### 2.1 基本格式

```json
{
  "template_id": "tw_einvoice_v1",
  "description": "範本描述",
  "version": "2.0",
  
  "anchor": {
    "enable": true,  // 或 false
    "text": "定位文字",
    "expected_bbox": {...}
  },
  
  "image_size": [2480, 3508],  // 絕對座標模式需要
  
  "regions": [...],
  "preprocess": {...},
  "ocr": {...},
  "postprocess": {...}
}
```

### 2.2 模式切換

透過 `anchor.enable` 欄位控制定位模式：

| anchor.enable | 定位模式 | 必填欄位 | 區域定義方式 |
|---------------|----------|----------|--------------|
| `true` | 相對座標模式 | anchor, regions, ocr | relative_to_anchor |
| `false` | 絕對座標模式 | image_size, regions | rect |

---

## 3. Anchor 定義（相對座標模式）

### 3.1 Anchor 結構

```json
{
  "anchor": {
    "enable": true,
    "text": "電子發票證明聯",
    "description": "定位文字 - 用於確定發票位置的錨點",
    "expected_bbox": {
      "width": 431.0,
      "height": 71.0,
      "tolerance_ratio": 0.2
    }
  }
}
```

### 3.2 欄位說明

- **enable**: 布林值，true 啟用相對座標模式，false 使用絕對座標模式
- **text**: 用於定位的文字內容（enable=true 時必填）
- **description**: 錨點用途說明（選填）
- **expected_bbox**: 預期的邊界框尺寸（enable=true 時必填）
  - **width**: 預期寬度（像素）
  - **height**: 預期高度（像素）
  - **tolerance_ratio**: 尺寸誤差容忍比例（0.2 = ±20%，範圍 0-1）

### 3.3 座標系統

```
(0,0) = Anchor 左上角
  ↓ +Y 方向（向下）
  → +X 方向（向右）

範例：
- 相對 X = 43  → 錨點右側 43 像素
- 相對 X = -31 → 錨點左側 31 像素
- 相對 Y = 147 → 錨點下方 147 像素
- 相對 Y = -57 → 錨點上方 57 像素
```

---

## 4. Regions 定義

### 4.1 相對座標模式（anchor.enable = true）

```json
{
  "name": "invoice_number",
  "description": "發票號碼 (例: VK-68915270)",
  "relative_to_anchor": {
    "x": 43.0,
    "y": 147.0,
    "width": 341.0,
    "height": 64.0,
    "tolerance_ratio": 0.3
  },
  "ocr_config": {
    "pattern": "^[A-Z]{2}-\\d{8}$",
    "expected_format": "XX-NNNNNNNN"
  },
  "validation": {
    "required": true,
    "min_confidence": 0.9
  }
}
```

**relative_to_anchor 欄位說明**：
- **x**: 相對於 anchor 左上角的 X 偏移量（可為負數）
- **y**: 相對於 anchor 左上角的 Y 偏移量（可為負數）
- **width**: ROI 區域寬度（必須為正數）
- **height**: ROI 區域高度（必須為正數）
- **tolerance_ratio**: 位置和尺寸的誤差容忍比例（0.3 = ±30%）

### 4.2 絕對座標模式（anchor.enable = false 或無 anchor）

```json
{
  "name": "invoice_no",
  "description": "發票號碼",
  "rect": {
    "x": 300,
    "y": 200,
    "width": 600,
    "height": 150
  },
  "ocr_lang": "eng",
  "postprocess": {
    "regex": "[A-Z0-9]+"
  }
}
```

**rect 欄位說明**：
- 格式：`{x, y, width, height}` 物件格式
- **x**: ROI 左上角的 X 座標（相對於影像左上角）
- **y**: ROI 左上角的 Y 座標（相對於影像左上角）
- **width**: ROI 區域寬度（必須為正數）
- **height**: ROI 區域高度（必須為正數）
- 座標原點：左上角 (0, 0)
- 限制：`0 <= x < x+width <= image_size[0]`，`0 <= y < y+height <= image_size[1]`

---

## 5. OCR 配置

### 5.1 全域配置（相對座標模式必填）

```json
{
  "ocr": {
    "engine": "paddleocr",
    "lang": "chinese_cht",
    "use_angle_cls": true,
    "min_confidence": 0.7
  }
}
```

**欄位說明**：
- **engine**: OCR 引擎名稱（如 "paddleocr"）
- **lang**: 語言設定，允許值：
  - `chinese_cht` - 繁體中文
  - `chinese_sim` - 簡體中文
  - `ch` - 中英混合
  - `en` - 英文
  - `chinese_tra` - 傳統中文
- **use_angle_cls**: 是否啟用角度分類（布林值）
- **min_confidence**: 全域最低信心分數（0-1）

### 5.2 區域級配置（絕對座標模式）

```json
{
  "name": "invoice_no",
  "rect": [300, 200, 900, 350],
  "ocr_lang": "eng",  // 僅絕對座標模式支援
  "ocr_config": {
    "pattern": "^[A-Z]{2}-\\d{8}$",
    "extract_pattern": "\\d{8}$",
    "expected_format": "XX-NNNNNNNN",
    "expected_type": "currency"
  }
}
```

**重要規則**：
- **相對座標模式**：禁止在 region 層級設定 `ocr_lang`，必須使用全域 `ocr.lang`
- **絕對座標模式**：允許每個 region 設定獨立的 `ocr_lang`

---

## 6. 預處理配置

```json
{
  "preprocess": {
    "deskew": true,
    "denoise": {
      "method": "bilateral",
      "enabled": true
    },
    "binarize": {
      "method": "adaptive",
      "enabled": false
    }
  }
}
```

### 6.1 欄位說明

| 欄位 | 型別 | 說明 | 允許值 |
|------|------|------|--------|
| deskew | boolean | 文字傾斜校正 | true / false |
| denoise.method | string | 去噪方法 | "nlm", "bilateral", "gaussian" |
| denoise.enabled | boolean | 是否啟用去噪 | true / false |
| binarize.method | string | 二值化方式 | "adaptive", "otsu", "threshold" |
| binarize.enabled | boolean | 是否啟用二值化 | true / false |

### 6.2 建議設定

- **繁體中文 OCR**：建議停用 binarize（實測發現會降低識別率）
- **英文/數字 OCR**：可啟用 adaptive binarize 提升對比度
- **降噪**：優先使用 bilateral（保留邊緣細節）

---

## 7. 後處理配置

```json
{
  "postprocess": {
    "remove_whitespace": true,
    "validate_patterns": true,
    "extract_values": true
  }
}
```

### 7.1 欄位說明

- **remove_whitespace**: 移除識別結果中的多餘空白
- **validate_patterns**: 使用正規表達式驗證格式
- **extract_values**: 根據 `extract_pattern` 提取數值部分

---

## 8. 驗證規則

### 8.1 必填欄位

**根層級必填**：
- `template_id` (string): 唯一識別碼，格式：`[a-z0-9_]+`
- `regions` (array): 至少包含一個 region

**相對座標模式額外必填**：
- `anchor` (object): 錨點定義
- `anchor.enable` (boolean): 必須為 true
- `anchor.text` (string): 定位文字
- `anchor.expected_bbox` (object): 預期邊界框
- `ocr` (object): 全域 OCR 配置
- `ocr.lang` (string): 語言設定

**絕對座標模式額外必填**：
- `image_size` (array): `[width, height]`，兩個正整數

### 8.2 Region 必填欄位

**相對座標模式**：
- `name` (string): 欄位名稱，不可重複
- `relative_to_anchor` (object): 相對位置定義
  - `x`, `y`, `width`, `height`, `tolerance_ratio`

**絕對座標模式**：
- `name` (string): 欄位名稱，不可重複
- `rect` (array): `[x1, y1, x2, y2]`，四個非負整數

### 8.3 數值範圍驗證

- **座標範圍**（絕對模式）：
  - `0 <= x1 < x2 <= image_size[0]`
  - `0 <= y1 < y2 <= image_size[1]`
  
- **影像尺寸**：
  - `width, height`: 100 ~ 10000 像素

- **容忍比例**：
  - `tolerance_ratio`: 0 ~ 1（0% ~ 100%）

- **信心分數**：
  - `min_confidence`: 0 ~ 1（0% ~ 100%）

---

## 9. 處理流程

### 9.1 相對座標模式流程

```
1. 載入範本 → 檢測 anchor.enable = true
2. 執行全張影像 OCR
3. 在 OCR 結果中尋找 anchor.text
4. 驗證 anchor 尺寸在容忍範圍內
5. 根據 relative_to_anchor 計算各欄位的絕對位置
6. 在容忍範圍內匹配 OCR 結果
7. 驗證格式（pattern）並提取數值（extract_pattern）
8. 檢查必填欄位和信心分數
```

### 9.2 絕對座標模式流程

```
1. 載入範本 → 檢測無 anchor 或 anchor.enable = false
2. 驗證 image_size 與輸入影像
3. 根據 rect 提取各 ROI 區域
4. 對每個 ROI 執行 OCR（使用 ocr_lang）
5. 套用 postprocess 規則
6. 回傳結果
```

---

## 10. 完整範例

### 10.1 相對座標模式範例（台灣電子發票）

```json
{
  "template_id": "tw_einvoice_v1",
  "description": "台灣電子發票證明聯格式 (統一範本格式)",
  "version": "2.0",
  
  "anchor": {
    "enable": true,
    "text": "電子發票證明聯",
    "description": "定位文字 - 用於確定發票位置的錨點",
    "expected_bbox": {
      "width": 431.0,
      "height": 71.0,
      "tolerance_ratio": 0.2
    }
  },
  
  "regions": [
    {
      "name": "invoice_number",
      "description": "發票號碼 (例: VK-68915270)",
      "relative_to_anchor": {
        "x": 43.0,
        "y": 147.0,
        "width": 341.0,
        "height": 64.0,
        "tolerance_ratio": 0.3
      },
      "ocr_config": {
        "pattern": "^[A-Z]{2}-\\d{8}$",
        "expected_format": "XX-NNNNNNNN"
      },
      "validation": {
        "required": true,
        "min_confidence": 0.9
      }
    }
  ],
  
  "preprocess": {
    "deskew": true,
    "denoise": {
      "method": "bilateral",
      "enabled": true
    },
    "binarize": {
      "method": "adaptive",
      "enabled": false
    }
  },
  
  "ocr": {
    "engine": "paddleocr",
    "lang": "chinese_cht",
    "use_angle_cls": true,
    "min_confidence": 0.7
  },
  
  "postprocess": {
    "remove_whitespace": true,
    "validate_patterns": true,
    "extract_values": true
  }
}
```

### 10.2 絕對座標模式範例

```json
{
  "template_id": "invoice_v1",
  "image_size": [2480, 3508],
  
  "anchor": {
    "enable": false
  },
  
  "regions": [
    {
      "name": "invoice_no",
      "rect": [300, 200, 900, 350],
      "ocr_lang": "eng",
      "postprocess": {
        "regex": "[A-Z0-9]+"
      }
    }
  ],
  
  "preprocess": {
    "deskew": true,
    "denoise": "nlm"
  }
}
```

---

## 11. 模式比較

| 特性 | 絕對座標模式 | 相對座標模式 |
|------|--------------|--------------|
| **定位方式** | 固定絕對座標 | 相對於 Anchor |
| **適用場景** | 格式完全統一的文件 | 格式有變化的文件 |
| **適應性** | 差（不同尺寸/位置需要新模板） | 好（自動適應位移） |
| **準確性** | 低（座標可能不準確） | 高（基於實際識別結果） |
| **必填欄位** | image_size, rect | anchor, relative_to_anchor, ocr |
| **Lang 設定** | 區域級（每個 region 獨立） | 全域級（統一設定） |
| **維護成本** | 高（需要精確量測座標） | 低（自動計算） |
| **擴展性** | 差 | 好（支援多 anchor、alternatives） |
| **處理流程** | 1. 提取 ROI<br>2. 執行 OCR | 1. 全張 OCR<br>2. 尋找 Anchor<br>3. 計算 ROI<br>4. 匹配結果 |

---

## 12. 設計原則

1. ✅ **統一格式**：透過 `anchor.enable` 開關統一兩種模式
2. ✅ **向後相容**：舊有絕對座標範本無需修改
3. ✅ **可版本化**：JSON 格式易於版本管理
4. ✅ **非程式化**：可由非工程人員調整
5. ✅ **靈活彈性**：支援兩種定位模式，適應不同需求
6. ✅ **清晰明確**：透過 enable 欄位明確指定模式

---

## 13. 最佳實踐

### 13.1 何時使用相對座標模式

- ✅ 文件格式有變化（位置、尺寸、旋轉）
- ✅ 有明確的定位文字（Logo、標題、特徵文字）
- ✅ 需要處理多種來源的同類文件
- ✅ 文件可能經過掃描或拍照（位置不固定）

### 13.2 何時使用絕對座標模式

- ✅ 文件格式完全統一（如制式表格）
- ✅ 影像尺寸固定
- ✅ 沒有明確的定位文字
- ✅ 簡單的固定位置欄位提取

### 13.3 容忍比例建議

- **anchor 尺寸容忍**: 0.2（±20%）- anchor 應該較為穩定
- **區域位置容忍**: 0.3（±30%）- 允許一定程度的變化
- **高精度欄位**: 0.1（±10%）- 對位置要求嚴格的欄位

---

## 14. 未來擴展

### 14.1 多 Anchor 支援

```json
{
  "anchors": [
    {
      "text": "電子發票證明聯",
      "priority": 1,
      "expected_bbox": {...}
    },
    {
      "text": "電子發票",
      "priority": 2,
      "expected_bbox": {...}
    }
  ]
}
```

### 14.2 替代區域定義

```json
{
  "name": "invoice_date",
  "alternatives": [
    {"relative_to_anchor": {"x": 31, "y": 72, ...}},
    {"relative_to_anchor": {"x": -28, "y": 220, ...}}
  ]
}
```

### 14.3 條件式處理

```json
{
  "name": "amount",
  "conditions": [
    {
      "if": "invoice_type == 'B2C'",
      "relative_to_anchor": {"x": 100, "y": 200, ...}
    },
    {
      "if": "invoice_type == 'B2B'",
      "relative_to_anchor": {"x": 150, "y": 250, ...}
    }
  ]
}
```

---

## 15. 總結

本統一規格透過 `anchor.enable` 開關整合了兩種定位模式：

1. ✅ **相對座標模式**（`enable: true`）
   - 基於 Anchor 定位，自動適應文件變化
   - 適用於台灣電子發票等格式有變化的文件
   - 全域 OCR 配置，統一語言設定

2. ✅ **絕對座標模式**（`enable: false`）
   - 固定座標定位，適用於格式統一的文件
   - 支援區域級 OCR 語言設定
   - 簡單直接，易於理解

這種設計提供了最大的靈活性，讓使用者可以根據實際需求選擇最合適的定位模式。
