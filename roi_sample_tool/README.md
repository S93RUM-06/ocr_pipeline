# ROI å–æ¨£å·¥å…·é–‹ç™¼è¦æ ¼

> **ROI Sampling Tool Specification**  
> å‰µå»ºæ—¥æœŸï¼š2025-12-23  
> æ›´æ–°æ—¥æœŸï¼š2025-12-23  
> ç‹€æ…‹ï¼š**é–‹ç™¼ä¸­ - Task 8 å·²å®Œæˆï¼ˆæ¨£æœ¬ç®¡ç†èˆ‡ç¯„æœ¬åŒ¯å‡ºï¼‰** âœ…

---

## ğŸ¯ æœ€æ–°åŠŸèƒ½ï¼šå®Œæ•´å·¥ä½œæµç¨‹å·²å¯¦ç¾

**å·²å¯¦ä½œåŠŸèƒ½**ï¼ˆ2025-12-23ï¼‰ï¼š
- âœ… **Profile ç®¡ç†**ï¼ˆFieldSetProfile, ProfileManager, CRUD UIï¼‰
- âœ… **æ‰¹æ¬¡å½±åƒè¼‰å…¥**ï¼ˆå–®å¼µ/å¤šå¼µè¼‰å…¥ï¼Œæ¨£æœ¬åˆ—è¡¨ç®¡ç†ï¼‰
- âœ… **ROI æ¨™è¨»**ï¼ˆæ»‘é¼ æ‹–æ›³ç¹ªè£½ï¼Œæ¨£æœ¬åˆ‡æ›è‡ªå‹•è¼‰å…¥ï¼‰
- âœ… **é€²åº¦è¿½è¹¤**ï¼ˆæ¨™è¨»å®Œæˆåº¦é¡¯ç¤ºï¼‰
- âœ… **çµ±è¨ˆè¨ˆç®—**ï¼ˆTemplateCalculator æ•´åˆï¼Œå“è³ªé©—è­‰ï¼‰
- âœ… **ç¯„æœ¬åŒ¯å‡º**ï¼ˆJSON åºåˆ—åŒ–ï¼ŒSchema é©—è­‰ï¼‰
- âœ… **é è¦½åŠŸèƒ½**ï¼ˆJSON å…§å®¹é è¦½ï¼‰

> ğŸ“– è©³ç´°ä½¿ç”¨èªªæ˜è«‹åƒè€ƒ [Profile ç®¡ç†æŒ‡å—](PROFILE_GUIDE.md)

---

## ğŸ“‹ ç›®éŒ„

1. [å·¥å…·æ¦‚è¿°](#å·¥å…·æ¦‚è¿°)
2. [åŠŸèƒ½éœ€æ±‚](#åŠŸèƒ½éœ€æ±‚)
3. [è¼¸å…¥è¼¸å‡º](#è¼¸å…¥è¼¸å‡º)
4. [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
5. [UI è¨­è¨ˆ](#ui-è¨­è¨ˆ)
6. [çµ±è¨ˆç®—æ³•](#çµ±è¨ˆç®—æ³•)
7. [æŠ€è¡“æ¶æ§‹](#æŠ€è¡“æ¶æ§‹)
8. [é–‹ç™¼è¨ˆåŠƒ](#é–‹ç™¼è¨ˆåŠƒ)

---

## å·¥å…·æ¦‚è¿°

### ç›®çš„

æœ¬å·¥å…·ç”¨æ–¼æ‰¹é‡è™•ç†å¤šå¼µåŒé¡å‹æ–‡æª”çš„æ¨£æœ¬åœ–ç‰‡ï¼Œå”åŠ©ä½¿ç”¨è€…æ¨™è¨» ROI å€åŸŸï¼Œä¸¦è‡ªå‹•ç”¢ç”Ÿç¬¦åˆ [æ¨¡æ¿ Schema è¦æ ¼](../docs/template_schema_specification.md) çš„ä½œæ¥­ç¯„æœ¬ JSON æª”æ¡ˆã€‚

### æ ¸å¿ƒåŠŸèƒ½

- âœ… **æ¬„ä½çµ„ Profile**ï¼šé è¨­å¸¸ç”¨æ¬„ä½é…ç½®ï¼Œå¿«é€Ÿé–‹å§‹æ¨™è¨»
- âœ… **æ‰¹é‡è¼‰å…¥åœ–ç‰‡**ï¼šæ”¯æ´å¤šå¼µæ¨£æœ¬åœ–ç‰‡ï¼ˆå–®å¼µ/æ‰¹æ¬¡è¼‰å…¥ï¼‰
- âœ… **æ¨£æœ¬ç®¡ç†**ï¼šæ¨£æœ¬åˆ—è¡¨ã€åˆ‡æ›ã€é€²åº¦è¿½è¹¤ã€ç§»é™¤
- âœ… **è¦–è¦ºåŒ–æ¨™è¨»**ï¼šæ‹–æ›³æ¡†é¸ ROI å€åŸŸ
- âœ… **çµ±è¨ˆè¨ˆç®—**ï¼šè‡ªå‹•è¨ˆç®—ç›¸å°æ¯”ä¾‹åº§æ¨™ã€æ¨™æº–å·®
- âœ… **å“è³ªé©—è­‰**ï¼šæ¨™æº–å·®è­¦å‘Šã€ç•°å¸¸æª¢æ¸¬
- âœ… **ç¯„æœ¬åŒ¯å‡º**ï¼šè¼¸å‡ºç¬¦åˆ Schema çš„ JSON æª”æ¡ˆ
- âœ… **JSON é è¦½**ï¼šåŒ¯å‡ºå‰é è¦½ç¯„æœ¬å…§å®¹
- âœ… **è‡ªå‹•é©—è­‰**ï¼šSchema åˆè¦æ€§æª¢æŸ¥

### è¨­è¨ˆåƒè€ƒ

æœ¬å·¥å…·ä¾æ“š [Template Schema v1.0](../docs/template_schema_specification.md) è¦æ ¼è¨­è¨ˆï¼Œç”¢ç”Ÿçš„æ¨¡æ¿ JSON å¿…é ˆï¼š

1. ä½¿ç”¨**ç›¸å°æ¯”ä¾‹åº§æ¨™ç³»çµ±**ï¼ˆ0-1 ä¹‹é–“ï¼‰
2. æ¡ç”¨**æ•´åœ–çµ±è¨ˆç­–ç•¥**ï¼ˆçµ±ä¸€åŸºæº–ï¼‰
3. åŒ…å«**æ¨™æº–å·®è³‡è¨Š**ï¼ˆè©•ä¼°ç©©å®šæ€§ï¼‰
4. ç¬¦åˆ `config/schemas/template-v1.0.json` é©—è­‰è¦å‰‡

---

## åŠŸèƒ½éœ€æ±‚

### FR-1: åœ–ç‰‡ç®¡ç†

| ID | åŠŸèƒ½ | èªªæ˜ | å„ªå…ˆç´š |
|----|------|------|--------|
| FR-1.1 | æ‰¹é‡è¼‰å…¥ | æ”¯æ´ä¸€æ¬¡è¼‰å…¥å¤šå¼µåœ–ç‰‡ï¼ˆâ‰¥10 å¼µå»ºè­°ï¼‰ | P0 |
| FR-1.2 | åœ–ç‰‡é è¦½ | ç¸®ç•¥åœ–åˆ—è¡¨é¡¯ç¤ºæ‰€æœ‰æ¨£æœ¬ | P0 |
| FR-1.3 | åœ–ç‰‡å°èˆª | å¿«é€Ÿåˆ‡æ›ä¸åŒæ¨£æœ¬åœ–ç‰‡ | P0 |
| FR-1.4 | åœ–ç‰‡è³‡è¨Š | é¡¯ç¤ºæª”åã€å¤§å°ï¼ˆå¯¬xé«˜ï¼‰ | P1 |

### FR-2: ROI æ¨™è¨»

| ID | åŠŸèƒ½ | èªªæ˜ | å„ªå…ˆç´š |
|----|------|------|--------|
| FR-2.1 | æ‹–æ›³æ¡†é¸ | æ»‘é¼ æ‹–æ›³æ¡†é¸ ROI å€åŸŸ | P0 |
| FR-2.2 | æ¬„ä½å‘½å | ç‚ºæ¯å€‹ ROI æŒ‡å®šæ¬„ä½åç¨± | P0 |
| FR-2.3 | åº§æ¨™èª¿æ•´ | å¾®èª¿ ROI ä½ç½®å’Œå¤§å° | P1 |
| FR-2.4 | åˆªé™¤/ç·¨è¼¯ | åˆªé™¤æˆ–é‡æ–°æ¨™è¨» ROI | P0 |
| FR-2.5 | è¤‡è£½æ¨™è¨» | å°‡ ROI åº§æ¨™è¤‡è£½åˆ°å…¶ä»–åœ–ç‰‡ | P1 |
| FR-2.6 | è‡ªå‹•å»ºè­° | æ ¹æ“šå·²æ¨™è¨»åœ–ç‰‡å»ºè­°æœªæ¨™è¨»åœ–ç‰‡çš„ ROIï¼ˆAI è¼”åŠ©ï¼‰ | P2 |

### FR-3: çµ±è¨ˆèˆ‡ç”¢ç”Ÿ

| ID | åŠŸèƒ½ | èªªæ˜ | å„ªå…ˆç´š |
|----|------|------|--------|
| FR-3.1 | çµ±è¨ˆè¨ˆç®— | è‡ªå‹•è¨ˆç®—å¹³å‡æ¯”ä¾‹ã€æ¨™æº–å·® | P0 |
| FR-3.2 | å“è³ªæª¢æŸ¥ | è­¦å‘Šæ¨™æº–å·®éå¤§çš„æ¬„ä½ | P0 |
| FR-3.3 | æ¨¡æ¿ç”¢ç”Ÿ | è¼¸å‡º JSON æ¨¡æ¿æª”æ¡ˆ | P0 |
| FR-3.4 | è¦–è¦ºåŒ–é©—è­‰ | å°‡çµ±è¨ˆçµæœç–ŠåŠ åˆ°åœ–ç‰‡ä¸Šé è¦½ | P1 |
| FR-3.5 | æ¨¡æ¿é©—è­‰ | è‡ªå‹•é©—è­‰ç”¢ç”Ÿçš„ JSON ç¬¦åˆ Schema | P0 |

### FR-4: é€²éšé…ç½®

| ID | åŠŸèƒ½ | èªªæ˜ | å„ªå…ˆç´š |
|----|------|------|--------|
| FR-4.1 | æ­£å‰‡è¨­å®š | ç‚ºæ¬„ä½è¨­å®š patternã€extract_group | P1 |
| FR-4.2 | è³‡æ–™é¡å‹ | è¨­å®š data_typeï¼ˆstring/number/date ç­‰ï¼‰ | P1 |
| FR-4.3 | é©—è­‰è¦å‰‡ | è¨­å®š min_lengthã€max_value ç­‰ | P2 |
| FR-4.4 | æ¬Šé‡è¨­å®š | è¨­å®š position_weightã€tolerance_ratio | P2 |

---

## è¼¸å…¥è¼¸å‡º

### è¼¸å…¥

```
Input:
  â”œâ”€â”€ æ¨£æœ¬åœ–ç‰‡æ‰¹æ¬¡ï¼ˆâ‰¥10 å¼µå»ºè­°ï¼‰
  â”‚   â”œâ”€â”€ invoice_001.jpg (1169 x 1654)
  â”‚   â”œâ”€â”€ invoice_002.jpg (1200 x 1700)
  â”‚   â”œâ”€â”€ invoice_003.png (1150 x 1620)
  â”‚   â””â”€â”€ ...
  â”‚
  â””â”€â”€ ï¼ˆå¯é¸ï¼‰ç¾æœ‰æ¨¡æ¿ JSON
      â””â”€â”€ ç”¨æ–¼ç·¨è¼¯æˆ–æ›´æ–°æ¨¡æ¿
```

### è¼¸å‡º

```
Output:
  â”œâ”€â”€ æ¨¡æ¿ JSON æª”æ¡ˆ
  â”‚   â””â”€â”€ tw_einvoice_v1.json  # ç¬¦åˆ Schema v1.0
  â”‚
  â”œâ”€â”€ æ¨™è¨»è³‡æ–™ï¼ˆå¯é¸ï¼‰
  â”‚   â””â”€â”€ annotations.json     # ä¿å­˜åŸå§‹æ¨™è¨»ä¾›å¾ŒçºŒèª¿æ•´
  â”‚
  â””â”€â”€ é©—è­‰å ±å‘Šï¼ˆå¯é¸ï¼‰
      â””â”€â”€ validation_report.txt # å“è³ªæª¢æŸ¥å ±å‘Š
```

### è¼¸å‡ºç¯„ä¾‹

```json
{
  "template_id": "tw_einvoice_v1",
  "template_name": "å°ç£é›»å­ç™¼ç¥¨è­‰æ˜è¯",
  "version": "1.0.0",
  "created_at": "2025-12-23",
  
  "processing_strategy": "hybrid_ocr_roi",
  
  "sampling_metadata": {
    "sample_count": 25,
    "reference_size": {
      "width": 1169,
      "height": 1654,
      "unit": "pixel",
      "description": "25å¼µæ¨£æœ¬åœ–ç‰‡çš„ä¸­ä½æ•¸å¤§å°"
    },
    "size_range": {
      "width": {"min": 1100, "max": 1250},
      "height": {"min": 1600, "max": 1700}
    },
    "sampling_date": "2025-12-23",
    "sampler_version": "1.0.0"
  },
  
  "regions": {
    "invoice_number": {
      "rect_ratio": {
        "x": 0.1394,
        "y": 0.5785,
        "width": 0.8273,
        "height": 0.1161
      },
      "rect_std_dev": {
        "x": 0.0012,
        "y": 0.0015,
        "width": 0.0008,
        "height": 0.0010
      },
      "pattern": "[A-Z]{2}-\\d{8}",
      "required": true,
      "description": "ç™¼ç¥¨è™Ÿç¢¼"
    }
  }
}
```

---

## å·¥ä½œæµç¨‹

### ä¸»æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¼‰å…¥åœ–ç‰‡æ‰¹æ¬¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. é¸æ“‡ç¬¬ä¸€å¼µ   â”‚ â—„â”€â”€â”€â”
â”‚    é–‹å§‹æ¨™è¨»     â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
         â”‚               â”‚
         â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ 3. æ‹–æ›³æ¡†é¸ ROI â”‚      â”‚
â”‚    (é‡è¤‡Nå€‹æ¬„ä½) â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
         â”‚               â”‚
         â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ 4. è¨­å®šæ¬„ä½å±¬æ€§  â”‚      â”‚
â”‚    (åç¨±/pattern)â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
         â”‚               â”‚
         â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ 5. åˆ‡æ›ä¸‹ä¸€å¼µ   â”‚ â”€â”€â”€â”€â”€â”˜
â”‚    (è¤‡è£½æˆ–é‡æ–°  â”‚   é‡è¤‡æ¨™è¨»æ‰€æœ‰åœ–ç‰‡
â”‚     æ¨™è¨»)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ æ‰€æœ‰åœ–ç‰‡æ¨™è¨»å®Œæˆ
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. çµ±è¨ˆè¨ˆç®—     â”‚
â”‚    (å¹³å‡å€¼/æ¨™æº–å·®)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. å“è³ªæª¢æŸ¥     â”‚
â”‚    (std_dev>0.1?)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. è¦–è¦ºåŒ–é è¦½   â”‚
â”‚    (ç–ŠåŠ çµ±è¨ˆçµæœ)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. ç”¢ç”Ÿ JSON    â”‚
â”‚    & é©—è­‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. å„²å­˜æ¨¡æ¿    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è©³ç´°æ­¥é©Ÿ

#### Step 1: è¼‰å…¥åœ–ç‰‡æ‰¹æ¬¡

```python
# ä½¿ç”¨æª”æ¡ˆé¸æ“‡å°è©±æ¡†
images = load_images_dialog()

# é¡¯ç¤ºæ‘˜è¦è³‡è¨Š
print(f"å·²è¼‰å…¥ {len(images)} å¼µåœ–ç‰‡")
print(f"å¤§å°ç¯„åœ: {min_width}x{min_height} ~ {max_width}x{max_height}")
```

#### Step 2-5: æ¨™è¨» ROI

```python
# å°æ¯å¼µåœ–ç‰‡
for img_id, image in enumerate(images):
    # é¡¯ç¤ºåœ–ç‰‡
    show_image(image)
    
    # æ¨™è¨» ROIï¼ˆå¯è¤‡è£½ä¸Šä¸€å¼µçš„åº§æ¨™ä½œç‚ºèµ·é»ï¼‰
    if img_id > 0 and user_wants_copy:
        annotations[img_id] = copy_and_adjust(annotations[img_id - 1])
    else:
        annotations[img_id] = annotate_from_scratch(image)
```

#### Step 6-7: çµ±è¨ˆèˆ‡å“è³ªæª¢æŸ¥

```python
# è¨ˆç®—çµ±è¨ˆå€¼ï¼ˆåƒè¦‹ä¸‹æ–¹çµ±è¨ˆç®—æ³•ï¼‰
template = calculate_template_from_annotations(annotations, image_sizes)

# å“è³ªæª¢æŸ¥
warnings = []
for field_name, field_config in template['regions'].items():
    std_dev = field_config['rect_std_dev']
    
    for key in ['x', 'y', 'width', 'height']:
        if std_dev[key] > 0.1:
            warnings.append(
                f"âš ï¸ {field_name}.{key} æ¨™æº–å·® {std_dev[key]:.4f} > 0.1"
                " (ä½ç½®ä¸ç©©å®šï¼Œå»ºè­°é‡æ–°æ¨™è¨»)"
            )

if warnings:
    show_warnings_dialog(warnings)
```

#### Step 8: è¦–è¦ºåŒ–é è¦½

```python
# å°‡çµ±è¨ˆçš„ rect_ratio ç–ŠåŠ åˆ°åƒè€ƒåœ–ç‰‡ä¸Š
reference_img = images[reference_index]
visualize_template_on_image(reference_img, template)
```

#### Step 9-10: ç”¢ç”Ÿèˆ‡é©—è­‰

```python
# ç”¢ç”Ÿ JSON
template_json = generate_template_json(template, metadata)

# é©—è­‰
from ocr_pipeline.template.schema_validator import TemplateSchemaValidator

validator = TemplateSchemaValidator()
is_valid, errors = validator.validate(template_json)

if is_valid:
    save_template(template_json, output_path)
else:
    show_errors_dialog(errors)
```

---

## UI è¨­è¨ˆ

### ä¸»è¦–çª—å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ROI å–æ¨£å·¥å…· v1.0                                    [_][â–¡][Ã—]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æª”æ¡ˆ(F)]  [ç·¨è¼¯(E)]  [æª¢è¦–(V)]  [å·¥å…·(T)]  [èªªæ˜(H)]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚            â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚  ç¸®ç•¥åœ–    â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚  åˆ—è¡¨      â”‚ â”‚          ä¸»è¦åœ–ç‰‡é¡¯ç¤ºå€åŸŸ                  â”‚â”‚
â”‚ â”‚            â”‚ â”‚          (å¯ç¸®æ”¾ã€æ‹–æ›³)                    â”‚â”‚
â”‚ â”‚ [1/25]     â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚ invoice_   â”‚ â”‚         ğŸ”² ROI æ¡†é¸                      â”‚â”‚
â”‚ â”‚ 001.jpg    â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚ âœ“          â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚            â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚ invoice_   â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚ 002.jpg    â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚            â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚   ...      â”‚ â”‚                                          â”‚â”‚
â”‚ â”‚            â”‚ â”‚                                          â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ æ¬„ä½å±¬æ€§é¢æ¿                                              â”‚â”‚
â”‚ â”‚                                                          â”‚â”‚
â”‚ â”‚ æ¬„ä½åç¨±: [invoice_number        â–¼]                      â”‚â”‚
â”‚ â”‚ æ­£å‰‡è¡¨é”å¼: [[A-Z]{2}-\d{8}                           ] â”‚â”‚
â”‚ â”‚ è³‡æ–™é¡å‹: [string              â–¼]                        â”‚â”‚
â”‚ â”‚ å¿…å¡«: [âœ“]  é æœŸé•·åº¦: [11]                                â”‚â”‚
â”‚ â”‚                                                          â”‚â”‚
â”‚ â”‚ [æ–°å¢æ¬„ä½] [åˆªé™¤æ¬„ä½] [è¤‡è£½åˆ°æ‰€æœ‰åœ–ç‰‡]                     â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·²æ¨™è¨»: 15/25 åœ–ç‰‡ | é€²åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘ 60%              â”‚
â”‚ [â—„ ä¸Šä¸€å¼µ] [ä¸‹ä¸€å¼µ â–º] [çµ±è¨ˆè¨ˆç®—] [ç”¢ç”Ÿæ¨¡æ¿]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é—œéµæ“ä½œ

| æ“ä½œ | èªªæ˜ |
|------|------|
| **æ»‘é¼ æ‹–æ›³** | æ¡†é¸æ–°çš„ ROI å€åŸŸ |
| **é»æ“Š ROI æ¡†** | é¸æ“‡ä¸¦ç·¨è¼¯ç¾æœ‰ ROI |
| **æ‹–æ›³ ROI é‚Šç·£** | èª¿æ•´ ROI å¤§å° |
| **Delete éµ** | åˆªé™¤é¸ä¸­çš„ ROI |
| **Ctrl+C/V** | è¤‡è£½/è²¼ä¸Š ROI åº§æ¨™ |
| **æ»‘é¼ æ»¾è¼ª** | ç¸®æ”¾åœ–ç‰‡ |
| **ç©ºç™½éµ+æ‹–æ›³** | å¹³ç§»åœ–ç‰‡ |

---

## çµ±è¨ˆç®—æ³•

### å®Œæ•´å¯¦ä½œ

åƒè¦‹ [Template Schema Specification - åº§æ¨™è½‰æ›å…¬å¼](../docs/template_schema_specification.md#åº§æ¨™è½‰æ›å…¬å¼)

### é—œéµæ­¥é©Ÿæ‘˜è¦

```python
import statistics

def calculate_template_from_samples(annotations, image_sizes):
    """
    å¾å¤šå¼µæ¨™è¨»åœ–ç‰‡è¨ˆç®—æ¨¡æ¿
    
    Args:
        annotations: [
            {'image_id': 0, 'regions': {'field1': {'x': 100, 'y': 200, ...}}},
            ...
        ]
        image_sizes: [(width, height), ...]
    
    Returns:
        Template dict
    """
    # Step 1: è¨ˆç®—åŸºæº–å¤§å°ï¼ˆä¸­ä½æ•¸ï¼‰
    widths = [size[0] for size in image_sizes]
    heights = [size[1] for size in image_sizes]
    
    reference_size = {
        'width': int(statistics.median(widths)),
        'height': int(statistics.median(heights)),
        'unit': 'pixel'
    }
    
    # Step 2: è½‰æ›ç‚ºæ¯”ä¾‹åº§æ¨™
    normalized_regions = {}
    
    for annot in annotations:
        img_w, img_h = image_sizes[annot['image_id']]
        
        for field_name, pixel_rect in annot['regions'].items():
            if field_name not in normalized_regions:
                normalized_regions[field_name] = []
            
            ratio = {
                'x': pixel_rect['x'] / img_w,
                'y': pixel_rect['y'] / img_h,
                'width': pixel_rect['width'] / img_w,
                'height': pixel_rect['height'] / img_h
            }
            normalized_regions[field_name].append(ratio)
    
    # Step 3: è¨ˆç®—å¹³å‡å€¼å’Œæ¨™æº–å·®
    template_regions = {}
    
    for field_name, ratios in normalized_regions.items():
        template_regions[field_name] = {
            'rect_ratio': {
                'x': round(statistics.mean(r['x'] for r in ratios), 4),
                'y': round(statistics.mean(r['y'] for r in ratios), 4),
                'width': round(statistics.mean(r['width'] for r in ratios), 4),
                'height': round(statistics.mean(r['height'] for r in ratios), 4)
            },
            'rect_std_dev': {
                'x': round(statistics.stdev(r['x'] for r in ratios), 4),
                'y': round(statistics.stdev(r['y'] for r in ratios), 4),
                'width': round(statistics.stdev(r['width'] for r in ratios), 4),
                'height': round(statistics.stdev(r['height'] for r in ratios), 4)
            }
        }
    
    return {
        'sampling_metadata': {
            'sample_count': len(annotations),
            'reference_size': reference_size,
            'size_range': {
                'width': {'min': min(widths), 'max': max(widths)},
                'height': {'min': min(heights), 'max': max(heights)}
            }
        },
        'regions': template_regions
    }
```

---

## æŠ€è¡“æ¶æ§‹

### æŠ€è¡“é¸å‹

| çµ„ä»¶ | æŠ€è¡“ | èªªæ˜ |
|------|------|------|
| **UI æ¡†æ¶** | PyQt6 æˆ– Tkinter | Python åŸç”Ÿ GUI |
| **åœ–ç‰‡è™•ç†** | OpenCV / Pillow | åœ–ç‰‡è¼‰å…¥ã€é¡¯ç¤º |
| **è³‡æ–™é©—è­‰** | jsonschema | Schema é©—è­‰ |
| **çµ±è¨ˆè¨ˆç®—** | statistics (å…§å»º) | å¹³å‡å€¼ã€æ¨™æº–å·® |

### æ¨¡çµ„çµæ§‹

```
roi_sample_tool/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶
â”œâ”€â”€ requirements.txt             # ä¾è³´å¥—ä»¶
â”œâ”€â”€ main.py                      # ä¸»ç¨‹å¼å…¥å£
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main_window.py       # ä¸»è¦–çª—
â”‚   â”‚   â”œâ”€â”€ image_canvas.py      # åœ–ç‰‡é¡¯ç¤ºç•«å¸ƒ
â”‚   â”‚   â”œâ”€â”€ thumbnail_list.py    # ç¸®ç•¥åœ–åˆ—è¡¨
â”‚   â”‚   â””â”€â”€ property_panel.py    # å±¬æ€§é¢æ¿
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ sampler.py           # çµ±è¨ˆè¨ˆç®—å¼•æ“
â”‚   â”‚   â”œâ”€â”€ annotation.py        # æ¨™è¨»è³‡æ–™æ¨¡å‹
â”‚   â”‚   â””â”€â”€ template_generator.py# æ¨¡æ¿ç”¢ç”Ÿå™¨
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ image_loader.py      # åœ–ç‰‡è¼‰å…¥å·¥å…·
â”‚       â””â”€â”€ visualizer.py        # è¦–è¦ºåŒ–å·¥å…·
â””â”€â”€ tests/
    â”œâ”€â”€ test_sampler.py
    â””â”€â”€ test_template_generator.py
```

---

## é–‹ç™¼è¨ˆåŠƒ

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆ1 é€±ï¼‰

- [ ] åœ–ç‰‡æ‰¹é‡è¼‰å…¥èˆ‡é¡¯ç¤º
- [ ] ROI æ‹–æ›³æ¡†é¸åŠŸèƒ½
- [ ] åŸºæœ¬å±¬æ€§è¨­å®šï¼ˆæ¬„ä½åç¨±ï¼‰
- [ ] çµ±è¨ˆè¨ˆç®—å¯¦ä½œ
- [ ] JSON æ¨¡æ¿ç”¢ç”Ÿ

### Phase 2: UI å„ªåŒ–ï¼ˆ3-5 å¤©ï¼‰

- [ ] ç¸®ç•¥åœ–åˆ—è¡¨
- [ ] æ¬„ä½å±¬æ€§é¢æ¿
- [ ] é€²åº¦é¡¯ç¤º
- [ ] è¤‡è£½ ROI åŠŸèƒ½

### Phase 3: é©—è­‰èˆ‡æ¸¬è©¦ï¼ˆ3-5 å¤©)

- [ ] Schema é©—è­‰æ•´åˆ
- [ ] å“è³ªæª¢æŸ¥ï¼ˆæ¨™æº–å·®è­¦å‘Šï¼‰
- [ ] è¦–è¦ºåŒ–é è¦½
- [ ] å–®å…ƒæ¸¬è©¦

### Phase 4: é€²éšåŠŸèƒ½ï¼ˆ1 é€±ï¼‰

- [ ] æ­£å‰‡è¡¨é”å¼è¨­å®š
- [ ] è³‡æ–™é¡å‹é¸æ“‡
- [ ] é©—è­‰è¦å‰‡é…ç½®
- [ ] è‡ªå‹•æ¨™è¨»å»ºè­°ï¼ˆAI è¼”åŠ©ï¼‰

---

## åƒè€ƒæ–‡æª”

- [Template Schema Specification](../docs/template_schema_specification.md) - æ¨¡æ¿è¦æ ¼å®šç¾©
- [Hybrid Extraction Strategy](../docs/hybrid_extraction_strategy.md) - æ··åˆæå–ç­–ç•¥
- JSON Schema å®˜æ–¹æ–‡æª”: https://json-schema.org/

---

**æ–‡ä»¶ç¶­è­·è€…**: GitHub Copilot  
**æœ€å¾Œæ›´æ–°**: 2025-12-23  
**ç‹€æ…‹**: é–‹ç™¼è¦æ ¼
