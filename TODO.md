# OCR Pipeline å°ˆæ¡ˆå¾…è¾¦äº‹é …

> æ›´æ–°æ—¥æœŸï¼š2025-12-23  
> æœ¬æ¸…å–®æ•´åˆå°ˆæ¡ˆè¦æ ¼ä¸­æœªå®Œæˆéƒ¨åˆ† + æœ¬æ¬¡æ¸¬è©¦ç™¼ç¾çš„æ”¹é€²éœ€æ±‚

---

## ğŸ¯ ç•¶å‰å°ˆæ¡ˆç‹€æ…‹ç¸½çµ

### âœ… å·²å®Œæˆé …ç›®

#### æ ¸å¿ƒæ¶æ§‹
- âœ… åŸºæœ¬å°ˆæ¡ˆçµæ§‹ï¼ˆadapters, core, stepsï¼‰
- âœ… PaddleOCR é©é…å™¨æ•´åˆ
- âœ… æ¨¡æ¿ç³»çµ±åŸºç¤æ¡†æ¶ï¼ˆv1 çµ•å°åº§æ¨™ã€v2 ç›¸å°åº§æ¨™ï¼‰
- âœ… Pipeline æµç¨‹ç·¨æ’å™¨
- âœ… éŒ¨é»å®šä½æ¨¡çµ„ï¼ˆAnchorLocatorï¼‰
- âœ… ROI æå–æ¨¡çµ„ï¼ˆROIExtractorï¼‰
- âœ… OpenCC ç¹ç°¡è½‰æ›æ•´åˆ

#### é›»å­ç™¼ç¥¨æ¸¬è©¦ï¼ˆæœ¬æ¬¡éšæ®µï¼‰
- âœ… é«˜è§£æåº¦æ¨£æœ¬æ›¿æ›ï¼ˆ2172Ã—1352, 2154Ã—1357ï¼‰
- âœ… ä¿®å¾© v2 éŒ¨é»æª¢æ¸¬ bbox å¤§å°é™åˆ¶å•é¡Œ
- âœ… ä¿®å¾©ç›¸å°åº§æ¨™è¨ˆç®—éŒ¯èª¤ï¼ˆå¾ center æ”¹ç‚º top_leftï¼‰
- âœ… æ›´æ–° v1/v2 æ¨¡æ¿åº§æ¨™ï¼ˆåŸºæ–¼ invoice_2.jpgï¼‰
- âœ… æ“´å±• ROI é‚Šç•Œå®¹éŒ¯ç¯„åœï¼ˆä¸Šä¸‹å·¦å³ +15pxï¼Œå³æ–¹å† +50pxï¼‰
- âœ… é©—è­‰å…¨åœ– OCR vs ROI OCR æ•ˆæœå°æ¯”
- âœ… è­˜åˆ¥ ROI æ–¹å¼å°ç„¡æ ¼ç·šæ–‡æª”çš„å±€é™æ€§

#### é—œéµç™¼ç¾
- âœ… **é›»å­ç™¼ç¥¨å…¨åœ– OCR æº–ç¢ºç‡ 95-100%**ï¼ˆVJ-50215372 98.5%ã€éš¨æ©Ÿç¢¼ 98.6%ï¼‰
- âœ… **ROI æ–¹å¼æ•ˆæœä¸ä½³åŸå› **ï¼šå¤šè¡Œæ–‡å­—å¹²æ“¾ã€å›ºå®šåº§æ¨™ç„¡æ³•é©æ‡‰è®ŠåŒ–ã€è£åˆ‡å°è‡´ä¸Šä¸‹æ–‡ä¸Ÿå¤±
- âœ… **æ ¸å¿ƒåŸç†ç™¼ç¾**ï¼šæ©Ÿå™¨å­¸ç¿’ OCRï¼ˆPaddleOCRï¼‰çš„å…©éšæ®µæµç¨‹ï¼š
  1. **æ–‡å­—æª¢æ¸¬**ï¼šç²¾ç¢ºå®šä½æ¯å€‹æ–‡å­—å€å¡Šçš„æœ€å°å¤–æ¥çŸ©å½¢ï¼ˆç„¡æ®˜ç¼ºæ–‡å­—ï¼‰
  2. **æ–‡å­—è¾¨è­˜**ï¼šå°ä¹¾æ·¨å–®è¡Œæ–‡å­—é€²è¡Œè¾¨è­˜ï¼ˆæ¨¡å‹è¨“ç·´å°±æ˜¯é‡å°æ­¤å„ªåŒ–ï¼‰
  - **ROI + tolerance çš„è‡´å‘½çµ„åˆ**ï¼šæ‰‹å‹•çŸ©å½¢åˆ‡å‰² + å®¹éŒ¯ç¯„åœæ“´å±• â†’ ä¸Šä¸‹ç·£åŒ…å«ä¸å®Œæ•´æ–‡å­—ç‰‡æ®µ â†’ OCR å¼•æ“ã€Œå¤±ç„¦ã€æ··æ·† â†’ æº–ç¢ºç‡å¾ 98% é™è‡³ 74%
  - **çµè«–**ï¼šè·³é OCR å¼•æ“çš„æª¢æ¸¬éšæ®µåè€Œç ´å£äº†å…¶å„ªå‹¢
- âœ… **æ¶æ§‹æ±ºç­–**ï¼šç„¡æ ¼ç·šæ–‡æª”æ‡‰æ¡ç”¨ã€Œå…¨åœ– OCR + æ­£å‰‡åŒ¹é…ã€ç­–ç•¥ï¼Œå……åˆ†åˆ©ç”¨ OCR å¼•æ“çš„æ–‡å­—æª¢æ¸¬èƒ½åŠ›

---

## ğŸš§ æœªå®Œæˆçš„åŸºç¤åŠŸèƒ½ï¼ˆä¾†è‡ªå°ˆæ¡ˆè¦æ ¼ï¼‰

### 1. è¼¸å…¥é©é…å™¨å¢å¼·
- [ ] PDF å¤šé è™•ç†ï¼ˆpdf2imageï¼‰
- [ ] DOCX/DOC è½‰åœ–ç‰‡æ”¯æ´
- [ ] TIFF å¤šé æ”¯æ´
- [ ] æ‰¹æ¬¡æª”æ¡ˆè™•ç†ä»‹é¢

### 2. é è™•ç†æ­¥é©Ÿå®Œå–„
- [ ] **æ ¼ç·šæª¢æ¸¬æ¨¡çµ„**ï¼ˆGridDetectorï¼‰
  - [ ] éœå¤«ç›´ç·šæª¢æ¸¬æ°´å¹³/å‚ç›´ç·š
  - [ ] æ ¼ç·šäº¤é»è¨ˆç®—
  - [ ] è¡¨æ ¼çµæ§‹è­˜åˆ¥
  
- [ ] **é€è¦–è®Šæ›çŸ¯æ­£**ï¼ˆPerspectiveCorrectorï¼‰
  - [ ] å¤–æ¡†å››è§’é»æª¢æ¸¬
  - [ ] åŸºæ–¼è§’é»çš„é€è¦–è®Šæ›
  - [ ] æ¨™æº–åŒ–å°ºå¯¸è¼¸å‡º
  
- [ ] **è‡ªé©æ‡‰å»å™ª**ï¼ˆAdaptiveDenoiseï¼‰
  - [ ] æ ¹æ“šåœ–ç‰‡è³ªé‡è‡ªå‹•èª¿æ•´åƒæ•¸
  - [ ] éå±€éƒ¨å‡å€¼å»å™ªï¼ˆNLMeansï¼‰
  
- [ ] **å½±åƒå“è³ªè©•ä¼°**ï¼ˆQualityAssessmentï¼‰
  - [ ] æ¨¡ç³Šåº¦æª¢æ¸¬
  - [ ] å°æ¯”åº¦è©•åˆ†
  - [ ] äº®åº¦å‡å‹»æ€§æª¢æŸ¥

### 3. OCR å¼•æ“æ“´å±•
- [ ] Tesseract é©é…å™¨
- [ ] EasyOCR é©é…å™¨
- [ ] å¤šå¼•æ“çµ„åˆç­–ç•¥ï¼ˆæŠ•ç¥¨æ©Ÿåˆ¶ï¼‰
- [ ] å¼•æ“æ€§èƒ½æ¯”è¼ƒå·¥å…·

### 4. å¾Œè™•ç†å±¤
- [ ] æ­£å‰‡è¡¨é”å¼é©—è­‰å™¨
- [ ] æ¥­å‹™è¦å‰‡æ ¡é©—ï¼ˆå¦‚çµ±ç·¨æ ¼å¼æª¢æŸ¥ï¼‰
- [ ] ä¿¡å¿ƒåˆ†æ•¸éæ¿¾
- [ ] çµæœçµæ§‹åŒ–è¼¸å‡ºï¼ˆJSON/XMLï¼‰

### 5. API æœå‹™
- [ ] FastAPI REST ä»‹é¢
- [ ] WebSocket å³æ™‚è™•ç†
- [ ] ä»»å‹™ä½‡åˆ—ç³»çµ±ï¼ˆCeleryï¼‰
- [ ] çµæœå¿«å–æ©Ÿåˆ¶

---

## ğŸ†• æœ¬æ¬¡æ¸¬è©¦ç™¼ç¾çš„æ–°éœ€æ±‚

### å„ªå…ˆç´š P0ï¼ˆé—œéµåŠŸèƒ½ï¼‰

#### 1. **æ¨£æœ¬æ¨™è¨»å·¥å…·**ï¼ˆSample Annotatorï¼‰
ğŸ“‹ **ç›®æ¨™**ï¼šæä¾›è¦–è¦ºåŒ–ä»‹é¢æ¨™è¨˜æ¨™æº–æ¨£æœ¬ç‰¹å¾µé»

**åŠŸèƒ½éœ€æ±‚**ï¼š
- [ ] è¼‰å…¥æ¨™æº–æ¨£æœ¬åœ–ç‰‡
- [ ] äº’å‹•å¼æ¨™è¨˜åŠŸèƒ½ï¼š
  - [ ] å››è§’é»æ¨™è¨˜ï¼ˆç”¨æ–¼é€è¦–è®Šæ›ï¼‰
  - [ ] éŒ¨é»æ–‡å­—ä½ç½®æ¨™è¨˜
  - [ ] æ ¼ç·šäº¤é»æ¨™è¨˜
  - [ ] ROI å€åŸŸæ¡†é¸ï¼ˆæ‹–æ›³çŸ©å½¢ï¼‰
- [ ] åŒ¯å‡º metadata åˆ° JSON
- [ ] é è¦½æ¨™è¨˜çµæœï¼ˆç–ŠåŠ åœ¨åœ–ç‰‡ä¸Šï¼‰
- [ ] æ”¯æ´å¤šæ¨£æœ¬æ‰¹æ¬¡æ¨™è¨»

**æŠ€è¡“é¸å‹**ï¼š
- ä»‹é¢ï¼šOpenCV HighGUI æˆ– Tkinter/PyQt
- è¼¸å‡ºæ ¼å¼ï¼šJSONï¼ˆæ•´åˆåˆ°æ¨¡æ¿æª”æ¡ˆï¼‰

**è¼¸å‡ºç¯„ä¾‹**ï¼š
```json
{
  "standard_sample": {
    "file": "id_card_standard.jpg",
    "size": [1000, 630],
    "feature_points": {
      "corners": [
        {"name": "top_left", "x": 50, "y": 30},
        {"name": "top_right", "x": 950, "y": 30},
        {"name": "bottom_right", "x": 950, "y": 600},
        {"name": "bottom_left", "x": 50, "y": 600}
      ],
      "anchor": {"text": "èº«åˆ†è­‰", "x": 100, "y": 50}
    },
    "grid_lines": {
      "horizontal": [120, 250, 380, 510],
      "vertical": [200, 500, 800]
    }
  }
}
```

---

#### 2. **åœ–åƒå°é½Šæ¨¡çµ„**ï¼ˆImageAlignerï¼‰
ğŸ“‹ **ç›®æ¨™**ï¼šå°‡è¼¸å…¥åœ–ç‰‡å°é½Šåˆ°æ¨™æº–æ¨£æœ¬åº§æ¨™ç³»

**åŠŸèƒ½éœ€æ±‚**ï¼š
- [ ] **ç‰¹å¾µé»åŒ¹é…å°é½Š**ï¼ˆæœ‰å¤–æ¡†æ–‡æª”ï¼‰
  - [ ] æª¢æ¸¬è¼¸å…¥åœ–ç‰‡çš„å››è§’é»
  - [ ] è¨ˆç®—é€è¦–è®Šæ›çŸ©é™£
  - [ ] å°é½Šåˆ°æ¨™æº–æ¨£æœ¬å°ºå¯¸
  
- [ ] **éŒ¨é»å°é½Š**ï¼ˆç„¡å¤–æ¡†ä½†æœ‰éŒ¨é»ï¼‰
  - [ ] å®šä½è¼¸å…¥åœ–ç‰‡çš„éŒ¨é»ä½ç½®
  - [ ] è¨ˆç®—å¹³ç§» + æ—‹è½‰è®Šæ›
  - [ ] å°é½Šåˆ°æ¨™æº–éŒ¨é»ä½ç½®
  
- [ ] **ç‰¹å¾µåŒ¹é…å°é½Š**ï¼ˆå®Œå…¨ç„¡çµæ§‹ï¼‰
  - [ ] SIFT/ORB ç‰¹å¾µé»æå–
  - [ ] ç‰¹å¾µåŒ¹é… + RANSAC
  - [ ] è¨ˆç®—ä»¿å°„è®Šæ›

**å¯¦ä½œæ­¥é©Ÿ**ï¼š
```python
class ImageAligner:
    def align_to_standard(self, input_image, template_metadata):
        strategy = self._determine_strategy(template_metadata)
        
        if strategy == "corners":
            return self._align_by_corners(input_image, template_metadata)
        elif strategy == "anchor":
            return self._align_by_anchor(input_image, template_metadata)
        else:
            return self._align_by_features(input_image, template_metadata)
```

---

#### 3. **æ¨¡æ¿é…ç½®å¢å¼·**ï¼ˆTemplate Schema v3ï¼‰
ğŸ“‹ **ç›®æ¨™**ï¼šæ¨¡æ¿æ”¯æ´å¤šç¨®è™•ç†ç­–ç•¥

**æ–°å¢æ¬„ä½**ï¼š
```json
{
  "template_id": "tw_id_card_v3",
  "processing_strategy": "grid_correction_roi",  // æˆ– "full_ocr_matching"
  
  "correction_strategy": "outer_frame",  // æˆ– "grid_lines" / "text_angle_only" / "none"
  
  "standard_sample": {
    "file": "samples/id_card_standard.jpg",
    "size": [1000, 630],
    "feature_points": {...}
  },
  
  "preprocessing": {
    "steps": ["grid_detect", "perspective_transform", "deskew"],
    "params": {
      "perspective_transform": {
        "target_size": [1000, 630]
      }
    }
  },
  
  "extraction_method": "fixed_roi",  // æˆ– "regex_pattern"
  
  "regions": [...],  // ROI å®šç¾©ï¼ˆextraction_method=fixed_roi æ™‚ä½¿ç”¨ï¼‰
  
  "patterns": {  // extraction_method=regex_pattern æ™‚ä½¿ç”¨
    "invoice_number": {"pattern": "[A-Z]{2}-\\d{8}"},
    "random_code": {"pattern": "éš¨æ©Ÿç¢¼[:ï¼š]\\s*(\\d{4})"}
  }
}
```

**éœ€å¯¦ä½œ**ï¼š
- [ ] æ¨¡æ¿é…ç½® schema é©—è­‰ï¼ˆJSON Schemaï¼‰
- [ ] å‘å¾Œç›¸å®¹è™•ç†ï¼ˆv1/v2 æ¨¡æ¿è‡ªå‹•è½‰æ›ï¼‰
- [ ] æ¨¡æ¿è¼‰å…¥å™¨é‡æ§‹

---

### å„ªå…ˆç´š P1ï¼ˆé‡è¦æ”¹é€²ï¼‰

#### 4. **å…¨åœ– OCR + æ­£å‰‡åŒ¹é…æå–å™¨**
ğŸ“‹ **ç›®æ¨™**ï¼šé‡å°ç„¡æ ¼ç·šæ–‡æª”çš„æœ€ä½³å¯¦è¸æ–¹æ¡ˆ

**åŠŸèƒ½éœ€æ±‚**ï¼š
- [ ] FullImageExtractor é¡åˆ¥å¯¦ä½œ
- [ ] æ­£å‰‡è¡¨é”å¼æ¨¡å¼åº«
- [ ] ä½ç½®è¼”åŠ©åŒ¹é…ï¼ˆåŒä¸€è¡Œã€ç›¸é„°å€åŸŸï¼‰
- [ ] å¤šå€™é¸çµæœè©•åˆ†æ©Ÿåˆ¶

**å¯¦ä½œç¯„ä¾‹**ï¼š
```python
class FullImageExtractor:
    def extract_fields(self, ocr_results, patterns):
        """
        Args:
            ocr_results: [(bbox, (text, confidence)), ...]
            patterns: {"field_name": {"pattern": r"...", "required": True}}
        """
        extracted = {}
        for field_name, config in patterns.items():
            candidates = self._find_matches(ocr_results, config['pattern'])
            best_match = self._select_best(candidates, config)
            extracted[field_name] = best_match
        return extracted
```

**æ¸¬è©¦æ¡ˆä¾‹**ï¼š
- [ ] é›»å­ç™¼ç¥¨æ¬„ä½æå–ï¼ˆç™¼ç¥¨è™Ÿç¢¼ã€éš¨æ©Ÿç¢¼ã€çµ±ç·¨ã€é‡‘é¡ï¼‰
- [ ] æ”¶æ“šæ¬„ä½æå–
- [ ] åˆç´„é—œéµè³‡è¨Šæå–

---

#### 5. **è™•ç†ç­–ç•¥è·¯ç”±å™¨**
ğŸ“‹ **ç›®æ¨™**ï¼šæ ¹æ“šæ¨¡æ¿è‡ªå‹•é¸æ“‡è™•ç†æµç¨‹

**åŠŸèƒ½éœ€æ±‚**ï¼š
- [ ] ç­–ç•¥è¨»å†Šæ©Ÿåˆ¶
- [ ] ç­–ç•¥é¸æ“‡é‚è¼¯
- [ ] é™ç´šç­–ç•¥ï¼ˆè‡ªå‹• fallbackï¼‰

**å¯¦ä½œæ¶æ§‹**ï¼š
```python
class ProcessingStrategyRouter:
    strategies = {
        "grid_correction_roi": GridCorrectionROIStrategy,
        "full_ocr_matching": FullOCRMatchingStrategy,
        "hybrid": HybridStrategy
    }
    
    def route(self, template):
        strategy_name = template.get("processing_strategy", "auto")
        if strategy_name == "auto":
            strategy_name = self._auto_detect(template)
        return self.strategies[strategy_name]()
```

---

### å„ªå…ˆç´š P2ï¼ˆå¢å¼·é«”é©—ï¼‰

#### 6. **è¦–è¦ºåŒ–é™¤éŒ¯å·¥å…·**
- [ ] Pipeline ä¸­é–“çµæœæŸ¥çœ‹å™¨
- [ ] ROI æå–çµæœç–ŠåŠ é¡¯ç¤º
- [ ] OCR çµæœç½®ä¿¡åº¦ç†±åŠ›åœ–
- [ ] å°é½Šå‰å¾Œå°æ¯”è¦–åœ–

#### 7. **æ•ˆèƒ½å„ªåŒ–**
- [ ] å¤šåŸ·è¡Œç·’ ROI ä¸¦è¡Œè™•ç†
- [ ] åœ–åƒå¿«å–æ©Ÿåˆ¶
- [ ] OCR å¼•æ“é€£ç·šæ± 
- [ ] æ‰¹æ¬¡è™•ç†å„ªåŒ–

#### 8. **æ¸¬è©¦è¦†è“‹**
- [ ] å–®å…ƒæ¸¬è©¦è£œé½Šï¼ˆç›®æ¨™ 80%+ï¼‰
- [ ] æ•´åˆæ¸¬è©¦æ¡ˆä¾‹
- [ ] ä¸åŒæ–‡æª”é¡å‹çš„ç«¯åˆ°ç«¯æ¸¬è©¦
- [ ] æ•ˆèƒ½åŸºæº–æ¸¬è©¦

---

## ğŸ“Š æ–‡æª”é¡å‹è™•ç†ç­–ç•¥è¡¨

| æ–‡æª”é¡å‹ | çŸ¯æ­£ç­–ç•¥ | æå–æ–¹æ³• | å„ªå…ˆç´š |
|---------|---------|---------|--------|
| **èº«åˆ†è­‰/å¥ä¿å¡** | `outer_frame` | `fixed_roi` | P0 |
| **é›»å­ç™¼ç¥¨** | `text_angle_only` | `regex_pattern` | P0 |
| **è¡¨æ ¼æ–‡ä»¶** | `grid_lines` | `fixed_roi` | P1 |
| **æ”¶æ“š** | `none` | `regex_pattern` | P1 |
| **åˆç´„** | `text_angle_only` | `regex_pattern` | P2 |
| **æ‰‹å¯«è¡¨å–®** | `outer_frame` | `hybrid` | P2 |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•å»ºè­°

### ç«‹å³å•Ÿå‹•ï¼ˆæœ¬é€±ï¼‰
1. **é–‹ç™¼æ¨£æœ¬æ¨™è¨»å·¥å…·**ï¼ˆSample Annotatorï¼‰
   - é¸æ“‡æŠ€è¡“æ¡†æ¶ï¼ˆå»ºè­° OpenCV HighGUI å¿«é€ŸåŸå‹ï¼‰
   - å¯¦ä½œåŸºæœ¬æ¨™è¨˜åŠŸèƒ½
   - æ¸¬è©¦èº«åˆ†è­‰æ¨™æº–æ¨£æœ¬æ¨™è¨»

2. **è¨­è¨ˆ Template Schema v3**
   - æ’°å¯« JSON Schema å®šç¾©
   - è¨­è¨ˆå‘å¾Œç›¸å®¹æ©Ÿåˆ¶
   - æº–å‚™é·ç§»æ–‡æª”

### çŸ­æœŸç›®æ¨™ï¼ˆ1-2 é€±ï¼‰
3. **å¯¦ä½œ ImageAligner æ¨¡çµ„**
   - å…ˆå¯¦ä½œ corners-based å°é½Šï¼ˆæœ€å¸¸ç”¨ï¼‰
   - æ•´åˆåˆ° Pipeline
   - æ¸¬è©¦èº«åˆ†è­‰å°é½Šæ•ˆæœ

4. **é–‹ç™¼ FullImageExtractor**
   - å¯¦ä½œæ­£å‰‡åŒ¹é…å¼•æ“
   - é›»å­ç™¼ç¥¨æ¡ˆä¾‹é©—è­‰
   - æº–ç¢ºç‡å°æ¯”æ¸¬è©¦

### ä¸­æœŸè¦åŠƒï¼ˆ1 å€‹æœˆï¼‰
5. **ç­–ç•¥è·¯ç”±å™¨æ•´åˆ**
6. **è¦–è¦ºåŒ–é™¤éŒ¯å·¥å…·**
7. **æ•ˆèƒ½å„ªåŒ– + æ¸¬è©¦è£œé½Š**

---

## ğŸ“ å‚™è¨»

- **é›»å­ç™¼ç¥¨ç¶“é©—æ•™è¨“**ï¼šROI æ–¹å¼ä¸é©åˆç„¡æ ¼ç·šæ–‡æª”ï¼Œå·²é€šéå¯¦æ¸¬é©—è­‰
- **æŠ€è¡“å‚µ**ï¼šv1/v2 æ¨¡æ¿éœ€é·ç§»åˆ° v3 schema
- **æ–‡æª”æ›´æ–°**ï¼šå®Œæˆæ–°æ¨¡çµ„å¾Œéœ€æ›´æ–°æ¶æ§‹æ–‡æª”

---

**æœ€å¾Œæ›´æ–°äºº**: GitHub Copilot  
**å¯©æ ¸ç‹€æ…‹**: å¾…å¯©æ ¸  
**ç›¸é—œæ–‡ä»¶**: [PROJECT_SPEC.md](PROJECT_SPEC.md), [00 åˆæ­¥æ§‹æƒ³.md](00%20åˆæ­¥æ§‹æƒ³.md)
